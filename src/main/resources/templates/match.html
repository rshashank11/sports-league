<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
        lang = "en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Bracket</title>
    <th:block th:replace="fragments/fonts :: font-links"></th:block>
    <th:block th:replace="fragments/styles :: style-links"></th:block>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/match.css}">
</head>
<body>
    <nav th:replace="fragments/header :: header"></nav>
    <h1 style="text-align: center;color: #c0392b;">
        League 1
    </h1>
    <div class="bracket">
        <div class="round" th:each="round : ${rounds}">
            <div class="match" th:each="match : ${round.matches}">
                <div class="player" th:classappend="${match.player1Score > match.player2Score} ? 'winner' : ''">
                    <span><img th:src="@{/images/image.png}" alt="Player Image"></span>
                    <span th:text="${match.playerName1}">Player 1</span>

                    <div th:if="${isAdmin}">
                        <!-- This is for admin only -->
                        <div sec:authorize="hasRole('ROLE_ADMIN')">
                            <input type="number"
                                   class="score-input player1"
                                   th:value="${match.player1Score}"
                                   min="0"
                                   max="1" />
                        </div>
                    </div>
                    <span th:text="${match.player1Score}">0</span> <!-- Display Player 1 score -->
                </div>

                <div class="player" th:classappend="${match.player2Score > match.player1Score} ? 'winner' : ''">
                    <span><img th:src="@{/images/image.png}" alt="Player Image"></span>
                    <span th:text="${match.playerName2}">Player 2</span>

                    <div th:if="${isAdmin}">
                        <!-- This is for admin only -->
                        <div sec:authorize="hasRole('ROLE_ADMIN')">
                            <!-- Input field for player 2 score -->
                            <input type="number"
                                   class="score-input player2"
                                   th:value="${match.player2Score}"
                                   min="0"
                                   max="1" />
                        </div>
                    </div>
                    <span th:text="${match.player2Score}">0</span>
                </div>
            </div>
        </div>
    </div>
</body>
<script th:inline="javascript">
    /*<![CDATA[*/
    document.querySelectorAll('.score-input').forEach(input => {
        input.addEventListener('change', function() {
            let player1Score = document.querySelector('.player1').value;
            let player2Score = document.querySelector('.player2').value;

            let xhr = new XMLHttpRequest();
            xhr.open('PUT', '/admin/update_match', true); // Using PUT request
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); // URL-encoded form data

            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {  // Request is done
                    if (xhr.status === 200) {  // Success
                        let response = xhr.responseText;
                        if (response === 'success') {
                            alert('Scores updated successfully!');
                            location.reload();  // Reload the page to reflect the changes
                        } else {
                            alert('Error updating scores!');
                        }
                    } else {
                        alert('Request failed.');
                    }
                }
            };

            // Send the scores in the request body as URL-encoded form data
            let params = `player1Score=${player1Score}&player2Score=${player2Score}`;
            xhr.send(params);
        });
    });
    /*]]>*/
</script>


</html>
